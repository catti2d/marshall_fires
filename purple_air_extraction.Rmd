---
title: "purple_air"
author: "Emma Rieves"
date: "2/2/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(readr)
library(plyr)
library(sf)
library(raster)
library(rgdal)
library(ggplot2)
library(spacetime)
library(gridExtra)
library(stringr)

# PM2.5 package recommended by Priyanka
library(bjzresc)

# to make the spherical geometry errors go away
sf::sf_use_s2(FALSE)
```

# Filter and load data
```{r}
## use bjzresc package to get list of purple air sensors; save to df instead of csv
pa_download = getPurpleairLst(output.path = NULL)
```

```{r}
## Use boulder county shapefile to extract municipal boundaries for Louisville and Superior
BO_CO = st_read("Boulder_county_munis/Municipalities.shp")

fire_areas = BO_CO %>% filter(ZONEDESC == "Louisville" |ZONEDESC == "Superior")

# creates variable for the projection of the BOCO shapefiles
prg = crs(fire_areas,asText=TRUE)
```

```{r}
## Intersect municipal boundaries with PA sensors

# remove null Lat/Long PA sensors -- important to creating spatial dataframe
pa_download = pa_download[complete.cases(pa_download[c("Lat","Lon")]),]

# check that it worked
sum(is.na(pa_download[c("Lat","Lon")]))

# create spatial dataframe 
pa_download_spatial = pa_download %>% 
  st_as_sf(coords = c("Lon","Lat")) %>% 
  st_set_crs(prg)

# check CRS
crs(pa_download_spatial)

# intersect PA download area and fire affected area to download sensors
fire_affected_sensors = st_intersection(pa_download_spatial,st_buffer(fire_areas,0))

# get sensor IDs for sensors in fire affected area
fire_area_sensor_IDs = fire_affected_sensors$ID

# filter original dataframe to include only sensors in fire affected area
fire_area_sensors = pa_download[pa_download$ID %in% fire_area_sensor_IDs, ]

# preview data
#fire_area_sensors
```

```{r}
## plot sensors within fire affected areas

# basemap = Superior and Louisville muni limits
basemap = ggplot(data=fire_areas) + 
  geom_sf()

# add on stations
sensor_map = basemap + geom_point(data=fire_area_sensors,aes(x=Lon,y=Lat))

# show map
sensor_map
```


```{r eval=F}
# download purple air data -- TAKES A LONG TIME TO RUN SO BE READY FOR THAT
## output path is a folder that stores a csv for each sensor for the target time period
## average means that data is averaged for 10-minute intervals
## indoor = TRUE includes indoor sensor observations

purpleairDownload(site.csv = fire_area_sensors, start.date = "2021-12-30", end.date = "2022-01-26", output.path = "sensors/", average = 10, time.zone = "America/Denver", indoor = TRUE, n.thread = 1)
```
# Function to help us get sensor info during analysis
```{r warning=FALSE}
# function that will get information from a sensor, based on its ID (e.g. 92321)
# a dataframe is returned with 5 columns: the ID number, the lon & lat coordinates, inside/outside location, and superior/louisville city
get_sensor_info <- function(ID) {
  info <- id_key[id_key$ID == ID,]
  city_pt <- st_intersection(sensor_map$data, st_as_sf(info, coords=c("Lon", "Lat"), crs=4326))["ZONEDESC"]
  city <- city_pt$ZONEDESC
  # print(city)
  info <- info %>%
    mutate(city = ifelse(length(city) == 0, NA, city)) %>%
    dplyr::select(-Name)
  return(info)
}
```

# Process and clean data
```{r}
## Read downloaded PA files from their filepath and turn them into a DF

# directory where files are stored
dir = "sensors/"

# create a list of all file names in this directory
file_names = list.files(path=dir, pattern="*.csv", full.names=TRUE)

# read csvs for each filename in list --> results in a list of lists
AQ_files = lapply(file_names, read_csv)

# fewer than above because A and B sensors come in separately
#length(AQ_files)
```

```{r}
## Combine lists of sensor data into a single dataframe

# combine AQ lists into single AQ dataframe
AQ_df = rbind.fill(AQ_files) %>% as.data.frame()

# preview data
#AQ_df
```

```{r}
## Clean data

# create a date column in POSIX format to create time series
AQ_df$datetime = as.POSIXct(AQ_df$created_at)

# rename and select important columns 
AQ_df = AQ_df %>% 
  dplyr::rename(pm25_a = `PM2.5_CF_1_ug/m3_A`,
                 pm25_b = `PM2.5_CF_1_ug/m3_B`,
                 temp = Temperature_F_A,
                 rh = `Humidity_%_A`) 

# create hourly pm colum
AQ_df$hour = as.POSIXlt(AQ_df$datetime)$hour

# Convert numeric values to a numeric class
AQ_df$pm25_a = as.numeric(AQ_df$pm25_a)
AQ_df$pm25_b = as.numeric(AQ_df$pm25_b)
AQ_df$temp = as.numeric(AQ_df$temp)
AQ_df$rh = as.numeric(AQ_df$rh)

# create hourly versions of temperature, pm, and rh
AQ_df_hr = AQ_df %>%
  group_by(ID, hour) %>%
  summarise(hourly_pm=mean(pm25_a),hourly_temp=mean(temp),hourly_rh=mean(rh))

# create a key coordinating the sensor ID number to its lat/lon
id_key <- AQ_df %>%
  group_by(ID) %>%
  dplyr::select(ID, Lon, Lat, Name, Location) %>%
  unique()

# select columns that I need for each spacetime object
AQ_df = AQ_df %>% 
  dplyr::select(ID, datetime, pm25_a, pm25_b, temp, rh, Lon, Lat) %>% as.data.frame()
  
# AQ_df_hr = AQ_df %>% 
#   dplyr::select(ID, hour, datetime, hourly_pm, hourly_temp, hourly_rh, Lon, Lat) %>% as.data.frame()
```


```{r}
## Some summary stats
AQ_df %>% group_by(ID) %>% summarise(count_A_na = sum(is.na(pm25_a)),
                                     count_B_na = sum(is.na(pm25_b)),
                                     pct_A_na = (count_A_na/length(pm25_a))*100,
                                     pct_B_na = (count_B_na/length(pm25_b))*100)
```

## Create spatial objects
```{r}
## Create spacetime objects -- 10 minute

# create spatial points object for each sensor
PA_sensors = SpatialPoints(AQ_df[!duplicated(AQ_df$ID), c("Lon", "Lat")],proj4string = CRS(prg))
summary(PA_sensors)

# contruct spatiotemporal object
PA_STFDF = stConstruct(AQ_df, space = c("Lon","Lat"), time = "datetime", crs = CRS(prg), SpatialObj = stations)
#hrly_STFDF = stConstruct(AQ_df_hr, space = c("Lon","Lat"), time = "datetime", crs = CRS(prg), SpatialObj = stations)

# turn ST object into a STFDF (stationary points)
PA_STFDF = as(PA_STFDF,"STFDF")
#hrly_STFDF = as(hrly_STFDF,"STFDF")

# see summary of data
summary(PA_STFDF)
#summary(hrly_STFDF)

# object class
class(PA_STFDF)
#class(hrly_STFDF)

# object dimensions
dim(PA_STFDF)
#dim(hrly_STFDF)
```

# Time series plots
```{r}
## Time series plots
# non_null_stations = PA_STFDF[na.omit(stations)]

# temp and rh ts
stplot(PA_STFDF[,"2021-12-30::2021-12-31","temp"],mode="ts")
stplot(PA_STFDF[,"2021-12-30::2021-12-31","rh"],mode="ts")
```

```{r}
# just using PM2.5_a for PM observations
stplot(PA_STFDF[,"2021-12-30::2021-12-31","pm25_a"],mode="ts")

# aggregate sensor data over the sensor_map geometries
aggregate_spatial <- aggregate(PA_STFDF[, "2021-12-30::2021-12-31"], as_Spatial(sensor_map$data$geometry), mean, na.rm=TRUE)
stplot(aggregate_spatial[, , "pm25_a"], mode="ts")
# trying a spatial plot, aggregated by every 4 hours
plot(sensor_map)
stplot(aggregate(aggregate_spatial, "4 hours", mean, na.rm=TRUE)[, , "pm25_a"])
```

```{r}
stplot(PA_STFDF[,"2021-12-30::2021-12-31","temp"],mode="xt")
stplot(PA_STFDF[,"2021-12-30::2021-12-31","rh"],mode="xt")

# just using PM2.5_a for PM observations
stplot(PA_STFDF[,"2021-12-30::2021-12-31","pm25_a"],mode="xt")
```

# Individual sensor plots
The plots are labeled in the form "sensor name - (city - in/outside) sensor id#" before the type of plot (pm2.5, temperature, or relative humidity.)

```{r warning=FALSE}
# add in pm25_b, temp, humidity
for (sensor in 1:30) {
  id <- id_key$ID[sensor]
  sensor_info <- get_sensor_info(id)
  # check that the sensor has some data for our time range
  sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
  if(length(sensor_xts$ID) > 0) {
    # plot pm2.5 on one graph for both channels
    sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
    sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
    p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
      geom_line() +
      geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
      scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
      labs(x="date",
           y="PM2.5",
           title = paste(sensor_info$city, "-", sensor_info$Location,
                         "\nsensor", id, "pm2.5"))
    # print(p)
    png(file=paste("images/sensor", id, "_pm25_ts.png"), width=500, height=500)
    print(p)
    dev.off()
    # plot temperature and relative humidity on one plot !!! this doesn't seem possible with ggplot
    sensor_temp <- sensor_xts["2021-12-30::2021-12-31", "temp"]
    sensor_rh <- sensor_xts["2021-12-30::2021-12-31", "rh"]
    
    p2 <- ggplot(fortify(sensor_temp), aes(x=Index, y=temp)) +
      geom_line() +
      labs(x="date",
           title = paste(sensor_info$city, "-", sensor_info$Location,
                         "\nsensor", id, "temperature"))
    
    p3 <- ggplot(fortify(sensor_rh), aes(x=Index, y=rh)) +
    geom_line() + 
      labs(x="date",
      title = paste(sensor_info$city, "-", sensor_info$Location,
                    "\nsensor", id, "relative humidity"))

    plots <- gridExtra::grid.arrange(p, arrangeGrob(p2, p3, ncol=2), nrow=2)
    print(plots)
    png(file=paste("images/sensor", id, "_ts.png"), width=500, height=500)
    print(plots)
    dev.off()
  }
}
```


```{r}
# save output to enhance resolution
jpeg(file = "images/timeplot.jpeg")
stplot(PA_STFDF[,"2021-12-30::2021-12-31","pm25_a"])
dev.off()
```


# Sensors with no data
Sensors with 0 data for the time period downloaded (12/30/2021 00:00:00 to 1/26/2022 12:30:00):
-119691
-120657
-120859
-125725
-128981
-129321
-130295
-130807
-131279
-134408
-134430
-137686
-142064
-142664
-142666
-75373
```{r}
stplot(PA_STFDF[,,"ID"], mode="ts")
```

## Something looks weird here!!
I'm (Zac) not sure what's going on here, but it's possible the data is a bit funky and needs more work.
There are 78761 NA's in the ID column of the data, so it's possible we're just seeing sensors that existed in the time period but weren't collecting any data for some reason.

# Inside vs. Outside Comparisons
Pairs gotten by looking at the purpleair sensor map, not every sensor has a close one, so I just picked the closest outdoor one we have data for. Generally on the same street, just a few houses down.

```{r}
# sensor 103724 - Louisville inside
id <- 103724
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))
# sensor 134408 - Louisville outside
id <- 65669
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p1 <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))

plots <- gridExtra::grid.arrange(p, p1, nrow=2)
print(plots)

# sensor 141956 - Louisville inside
id <- 141956
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))
# sensor 81149 - Louisville outside
id <- 81149
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p1 <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))

plots <- gridExtra::grid.arrange(p, p1, nrow=2)
print(plots)

# sensor 79097 - Louisville inside
id <- 79097
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))
# sensor 81149 - Lousiville outside
id <- 81149
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p1 <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))

plots <- gridExtra::grid.arrange(p, p1, nrow=2)
print(plots)

# sensor 88533 - Louisville inside
id <- 88533
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))
# sensor 92321 - Louisville outside
id <- 92321
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p1 <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))

plots <- gridExtra::grid.arrange(p, p1, nrow=2)
print(plots)
```


# Full Time Series Plots
```{r}
# pm2.5 of full time period
stplot(PA_STFDF[,,"pm25_a"], mode="ts")

for (sensor in 1:30) {
  id <- id_key$ID[sensor]
  sensor_info <- get_sensor_info(id)
  # check that the sensor has some data for our time range
  sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
  # print(id)
  # print(length(sensor_xts$ID))
  if(length(sensor_xts$ID) > 0) {
    # plot pm2.5 on one graph for both channels
    sensor_pm25a <- sensor_xts[, "pm25_a"]
    sensor_pm25b <- sensor_xts[, "pm25_b"]
    p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
      geom_line() +
      geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
      scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black",
                                                          "PM2.5 B Channel" = "tomato")) +
      labs(x="date",
           y="PM2.5",
           title = paste(sensor_info$city, "-", sensor_info$Location,
                         "\nsensor", id, "pm2.5"))
    print(p)
  }
}
```


# To do
- add columns to data - offline during fire, added after fire
- ~~pm25 of full time period~~
- points of all sensors, color coded by time period (before, burned, added after)
- ~~look at paired inside/outside~~
- map of sensors by area & time period
- two columns of time series sensor plots for fire period, inside vs outside

