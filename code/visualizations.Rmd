---
title: "marshall_visualizations"
author: "Emma Rieves"
date: "4/27/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## bring in data
```{r}
# AIR QUALITY
## corrected air quality
AQ_df = read.csv("/Users/esrieves/Documents/GitHub/marshall_fires/intermediary_outputs/corrected_AQ_data.csv")

## sensor info
sensors = read.csv("/Users/esrieves/Documents/GitHub/marshall_fires/intermediary_outputs/sensor_data_full.csv")
```

```{r}
# BOUNDARIES
# Boulder boundaries
BO_CO = st_read("/Users/esrieves/Documents/GitHub/marshall_fires/GIS_inputs_destruction_fireboundary/Boulder_county_munis/Municipalities.shp")
(fire_counties = BO_CO %>% filter(ZONEDESC == "Louisville" | ZONEDESC == "Superior" | ZONEDESC == "Broomfield" | ZONEDESC == "Lafayette" | ZONEDESC == "Boulder"))

# save proj string for fire-affected counties to use for other transformations
prg = raster::crs(fire_counties,asText=TRUE)

# Marshall fire boundary
wfigs_fire = st_read("/Users/esrieves/Documents/GitHub/marshall_fires/GIS_inputs_destruction_fireboundary/WFIGS_-_Wildland_Fire_Perimeters_Full_History/FH_Perimeter.shp")

# filter fire to marshall fire only; update crs
(marshall_fire = wfigs_fire %>% filter(poly_Incid == "Marshall") %>% st_transform(crs = st_crs(prg)))
```

```{r}
# BUILDINGS
# Read in destroyed home and building sites
destroyed_homes = st_read("/Users/esrieves/Documents/GitHub/marshall_fires/GIS_inputs_destruction_fireboundary/output_damage_files/destroyed_homes.shp")
damaged_homes = st_read("/Users/esrieves/Documents/GitHub/marshall_fires/GIS_inputs_destruction_fireboundary/output_damage_files/damaged_homes.shp")
destroyed_businesses = st_read("/Users/esrieves/Documents/GitHub/marshall_fires/GIS_inputs_destruction_fireboundary/output_damage_files/destroyed_businesses.shp")
damaged_businesses = st_read("/Users/esrieves/Documents/GitHub/marshall_fires/GIS_inputs_destruction_fireboundary/output_damage_files/damaged_businesses.shp")


# create 'type' column; select only the columns needed; make projection string match
(destroyed_homes = destroyed_homes %>% mutate(type = "destroyed - residential") %>% dplyr::rename(jurisdiction = JURISDICTI) %>% dplyr::select(jurisdiction, type, latlong, geometry) %>% st_transform(crs = st_crs(prg)))
(destroyed_businesses = destroyed_businesses  %>% mutate(type = "destroyed - non-residential") %>% dplyr::rename(jurisdiction = Jurisdicti) %>% dplyr::select(jurisdiction, type, latlong, geometry) %>% st_transform(crs = st_crs(prg)))
(damaged_homes = damaged_homes %>% mutate(type = "damaged - residential") %>% dplyr::rename(jurisdiction = JURISDICTI) %>% dplyr::select(jurisdiction, type, latlong, geometry) %>% st_transform(crs = st_crs(prg)))
(damaged_business = damaged_businesses %>% mutate(type = "damaged - non-residential") %>% dplyr::rename(jurisdiction = Jurisdicti) %>% dplyr::select(jurisdiction, type, latlong, geometry) %>% st_transform(crs = st_crs(prg)))

# combine into one df, using the "," indicator keeps decimal points
(destroyed_damaged =rbind(destroyed_homes,destroyed_businesses,damaged_homes,damaged_business) %>% separate(latlong, c("lat","long"), ",", convert = FALSE))

# change lat and long to floats
destroyed_damaged$lat = as.double(destroyed_damaged$lat)
destroyed_damaged$long = as.double(destroyed_damaged$long)
```



# Maps
```{r}
# create "location status" column for mapping
library(stringr)
sensors$loc_status = str_c(sensors$Location, " - ", sensors$Status)

# turned this on to get code to run -- should update classification code in the extraction file
sensors = na.omit(sensors)
```

```{r}
# set factors to false
options(stringsAsFactors = FALSE)

# create pallete for destroyed and damaged building colors for leaflet map
pal = colorFactor(c("red","orange","magenta","light pink"), domain = unique(destroyed_damaged$type))


## create indoor/outdoor icons
sensorIcon = awesomeIconList(
  "inside" = makeAwesomeIcon(
    icon = "home",
    iconColor = "white",
    markerColor = "blue",
    library = "fa"
  ),
  "outside" = makeAwesomeIcon(
    icon = "tree",
    iconColor = "white",
    markerColor = "green",
    library = "fa"
  ))


# create pallete for location + time period
timeSensorIcon = awesomeIconList(
  "inside - Complete data throughout fire period" = makeAwesomeIcon(
    icon = "home",
    iconColor = "white",
    markerColor = "green",
    library = "fa"
  ),
  "inside - Sensor added during fire, returned online" = makeAwesomeIcon(
    icon = "home",
    iconColor = "white",
    markerColor = "blue",
    library = "fa"
  ),
  "inside - Sensor came online after fire" = makeAwesomeIcon(
    icon = "home",
    iconColor = "white",
    markerColor = "light purple",
    library = "fa"
  ),
  "inside - Sensor offline during fire, returned online" = makeAwesomeIcon(
    icon = "home",
    iconColor = "white",
    markerColor = "blue",
    library = "fa"
  ),
   "outside - Complete data throughout fire period" = makeAwesomeIcon(
    icon = "home",
    iconColor = "white",
    markerColor = "green",
    library = "fa"
  ),
  "outside - Sensor added during fire, did not return online" = makeAwesomeIcon(
    icon = "tree",
    iconColor = "white",
    markerColor = "gray",
    library = "fa"
  ),
  "outside - Sensor came online after fire" = makeAwesomeIcon(
    icon = "tree",
    iconColor = "white",
    markerColor = "light purple",
    library = "fa"
  ),
  "outside - Sensor offline during fire, did not return online" = makeAwesomeIcon(
    icon = "tree",
    iconColor = "white",
    markerColor = "gray",
    library = "fa"
  ),
  "outside - Sensor offline during fire, returned online" = makeAwesomeIcon(
    icon = "tree",
    iconColor = "white",
    markerColor = "blue",
    library = "fa"
  ))

sensors

# map of damaged/destroyed buildings and AQ sensors (indoor/outdoor)
# chose not to do icons for destroyed/damaged buildings because the map got really busy
(fire_destruction_and_AQ_plot = leaflet(sensors) %>%
    addTiles() %>% 
    addAwesomeMarkers(icon = ~sensorIcon[Location],
                      lng = sensors$Lon, lat = sensors$Lat) %>% 
    addCircleMarkers(color = ~pal(destroyed_damaged$type),
                     radius = 3.5,
                     opacity = 1,
                     lng = destroyed_damaged$long, lat = destroyed_damaged$lat) %>%
    addLegend("topright", pal = pal, values = ~destroyed_damaged$type,
              title = "Fire damage"))



# map based on when sensor was added
(fire_destruction_and_AQ_plot = leaflet(sensors) %>%
    addTiles() %>% 
    addAwesomeMarkers(icon = ~timeSensorIcon[loc_status],
                      lng = sensors$Lon, lat = sensors$Lat) %>% 
    addCircleMarkers(color = ~pal(destroyed_damaged$type),
                     radius = 3.5,
                     opacity = 1,
                     lng = destroyed_damaged$long, lat = destroyed_damaged$lat) %>%
    addLegend("topright", pal = pal, values = ~destroyed_damaged$type,
              title = "Fire damage"))


```




## Create spatial objects
```{r}
## Create spacetime objects -- 10 minute

# first, re-format datetime as a xts object
AQ_df$datetime = as.POSIXct(AQ_df$datetime)

# create spatial points object for each sensor
PA_sensors = SpatialPoints(AQ_df[!duplicated(AQ_df$ID), c("Lon", "Lat")],proj4string = CRS(prg))
summary(PA_sensors)

# contruct spatiotemporal object
PA_STFDF = stConstruct(AQ_df, space = c("Lon","Lat"), time = "datetime", crs = CRS(prg), SpatialObj = sensors)
#hrly_STFDF = stConstruct(AQ_df_hr, space = c("Lon","Lat"), time = "datetime", crs = CRS(prg), SpatialObj = stations)

# turn ST object into a STFDF (stationary points)
PA_STFDF = as(PA_STFDF,"STFDF")
#hrly_STFDF = as(hrly_STFDF,"STFDF")

# see summary of data
summary(PA_STFDF)
#summary(hrly_STFDF)

# object class
class(PA_STFDF)
#class(hrly_STFDF)

# object dimensions
dim(PA_STFDF)
#dim(hrly_STFDF)
```

# Time series plots
```{r}
## Time series plots
# non_null_stations = PA_STFDF[na.omit(stations)]

# temp and rh ts
stplot(PA_STFDF[,"2021-12-30::2021-12-31","temp"],mode="ts")
stplot(PA_STFDF[,"2021-12-30::2021-12-31","rh"],mode="ts")
stplot(PA_STFDF[,"2021-12-30::2021-12-31","corrected_pm"],mode="ts")
```

```{r}
# NOTE
## I removed the sensor map (I think to the bottom of this script) so this didn't work for me
# aggregate sensor data over the sensor_map geometries
aggregate_spatial <- aggregate(PA_STFDF[, "2021-12-30::2021-12-31"], as_Spatial(sensor_map$data$geometry), mean, na.rm=TRUE)
stplot(aggregate_spatial[, , "pm25_a"], mode="ts")
# trying a spatial plot, aggregated by every 4 hours
plot(sensor_map)
stplot(aggregate(aggregate_spatial, "4 hours", mean, na.rm=TRUE)[, , "pm25_a"])
```

```{r}
stplot(PA_STFDF[,"2021-12-30::2021-12-31","temp"],mode="xt")
stplot(PA_STFDF[,"2021-12-30::2021-12-31","rh"],mode="xt")

# just using PM2.5_a for PM observations
stplot(PA_STFDF[,"2021-12-30::2021-12-31","corrected_pm"],mode="xt")
```

# Individual sensor plots
The plots are labeled in the form "sensor name - (city - in/outside) sensor id#" before the type of plot (pm2.5, temperature, or relative humidity.)

```{r warning=FALSE}
# add in pm25_b, temp, humidity
for (sensor in 1:30) {
  id <- id_key$ID[sensor]
  sensor_info <- get_sensor_info(id)
  # check that the sensor has some data for our time range
  sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
  if(length(sensor_xts$ID) > 0) {
    # plot pm2.5 on one graph for both channels
    sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
    sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
    p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
      geom_line() +
      geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
      scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
      labs(x="date",
           y="PM2.5",
           title = paste(sensor_info$city, "-", sensor_info$Location,
                         "\nsensor", id, "pm2.5"))
    # print(p)
    png(file=paste("images/sensor", id, "_pm25_ts.png"), width=500, height=500)
    print(p)
    dev.off()
    # plot temperature and relative humidity on one plot !!! this doesn't seem possible with ggplot
    sensor_temp <- sensor_xts["2021-12-30::2021-12-31", "temp"]
    sensor_rh <- sensor_xts["2021-12-30::2021-12-31", "rh"]
    
    p2 <- ggplot(fortify(sensor_temp), aes(x=Index, y=temp)) +
      geom_line() +
      labs(x="date",
           title = paste(sensor_info$city, "-", sensor_info$Location,
                         "\nsensor", id, "temperature"))
    
    p3 <- ggplot(fortify(sensor_rh), aes(x=Index, y=rh)) +
    geom_line() + 
      labs(x="date",
      title = paste(sensor_info$city, "-", sensor_info$Location,
                    "\nsensor", id, "relative humidity"))

    plots <- gridExtra::grid.arrange(p, arrangeGrob(p2, p3, ncol=2), nrow=2)
    print(plots)
    png(file=paste("images/sensor", id, "_ts.png"), width=500, height=500)
    print(plots)
    dev.off()
  }
}
```


```{r}
# save output to enhance resolution
jpeg(file = "images/timeplot.jpeg")
stplot(PA_STFDF[,"2021-12-30::2021-12-31","pm25_a"])
dev.off()
```


# Sensors with no data
Sensors with 0 data for the time period downloaded (12/30/2021 00:00:00 to 1/26/2022 12:30:00):
-119691
-120657
-120859
-125725
-128981
-129321
-130295
-130807
-131279
-134408
-134430
-137686
-142064
-142664
-142666
-75373
```{r}
stplot(PA_STFDF[,,"ID"], mode="ts")
```

## Something looks weird here!!
I'm (Zac) not sure what's going on here, but it's possible the data is a bit funky and needs more work.
There are 78761 NA's in the ID column of the data, so it's possible we're just seeing sensors that existed in the time period but weren't collecting any data for some reason.

# Inside vs. Outside Comparisons
Pairs gotten by looking at the purpleair sensor map, not every sensor has a close one, so I just picked the closest outdoor one we have data for. Generally on the same street, just a few houses down.

```{r}
# sensor 103724 - Louisville inside
id <- 103724
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))
# sensor 134408 - Louisville outside
id <- 65669
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p1 <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))

plots <- gridExtra::grid.arrange(p, p1, nrow=2)
print(plots)

# sensor 141956 - Louisville inside
id <- 141956
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))
# sensor 81149 - Louisville outside
id <- 81149
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p1 <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))

plots <- gridExtra::grid.arrange(p, p1, nrow=2)
print(plots)

# sensor 79097 - Louisville inside
id <- 79097
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))
# sensor 81149 - Lousiville outside
id <- 81149
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p1 <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))

plots <- gridExtra::grid.arrange(p, p1, nrow=2)
print(plots)

# sensor 88533 - Louisville inside
id <- 88533
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))
# sensor 92321 - Louisville outside
id <- 92321
sensor_info <- get_sensor_info(id)
sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
# plot pm2.5 on one graph for both channels
sensor_pm25a <- sensor_xts["2021-12-30::2021-12-31", "pm25_a"]
sensor_pm25b <- sensor_xts["2021-12-30::2021-12-31", "pm25_b"]
p1 <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
  geom_line() +
  geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
  scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black", "PM2.5 B Channel" = "tomato")) +
  labs(x="date",
       y="PM2.5",
       title = paste(sensor_info$city, "-", sensor_info$Location, sensor_info$Lon,",", sensor_info$Lat,
                     "\nsensor", id, "pm2.5"))

plots <- gridExtra::grid.arrange(p, p1, nrow=2)
print(plots)
```


# Full Time Series Plots
```{r}
# pm2.5 of full time period
stplot(PA_STFDF[,,"pm25_a"], mode="ts")

for (sensor in 1:30) {
  id <- id_key$ID[sensor]
  sensor_info <- get_sensor_info(id)
  # check that the sensor has some data for our time range
  sensor_xts <- PA_STFDF[PA_STFDF@data$ID == id]
  # print(id)
  # print(length(sensor_xts$ID))
  if(length(sensor_xts$ID) > 0) {
    # plot pm2.5 on one graph for both channels
    sensor_pm25a <- sensor_xts[, "pm25_a"]
    sensor_pm25b <- sensor_xts[, "pm25_b"]
    p <- ggplot(fortify(sensor_pm25a), aes(x=Index, y=pm25_a, color="black")) +
      geom_line() +
      geom_line(data=fortify(sensor_pm25b), aes(y=pm25_b), color="tomato") +
      scale_color_manual(name = "Sensor Data", values = c("PM2.5 A Channel" = "black",
                                                          "PM2.5 B Channel" = "tomato")) +
      labs(x="date",
           y="PM2.5",
           title = paste(sensor_info$city, "-", sensor_info$Location,
                         "\nsensor", id, "pm2.5"))
    print(p)
  }
}
```


# Old Code
```{r}
# why is one showing up way off -- investigate, I wonder if this sensor moved during the process?
# sensor 112606
# png(file = "images/fire_map2.png", width = 4500, height = 3800, res = 300)
# (detailed_sensor_map = basemap + 
#     geom_point(data=(plot_data %>% filter(ID != "112606")), aes(x=Lon,y=Lat, label = ID, shape = Location, color = Status, label = rownames(ID))) +
#     scale_colour_brewer(palette = "Set1") +
#     theme_light() +
#     theme(legend.position = "bottom", legend.box = "vertical") +
#     #guides(scale = FALSE) +
#     ggtitle("Map of sensors in Louisville and Superior, 12-30-21 to 2-26-22"))
# dev.off()

# add sensors, check which sensor is off
# (ggplot(plot_data, aes(x=Lon,y=Lat, label = ID, shape = Location, color = fire_period, label = ID))) + 
#   geom_point() +
#   geom_text(check_overlap = TRUE)


# Create time period variable based on availability during fire, inside/outside status for mapping
# (plot_data = AQ_df %>%
#   group_by(ID) %>%
#   dplyr::select(ID, Lon, Lat, Location) %>%
#   # use location[1] presuming indoor/outdoor doesn't change
#   dplyr::summarize(Location = Location[1],
#                    Lat = Lat[1],
#                    Lon = Lon[1]))
```

```{r}
# png(file = "images/month_map.png", width = 6000, height = 3800, res = 300)
# (month_plot = basemap +
#   geom_point(data = month_added_plot, aes(x=Lon,y=Lat, label = ID, shape = Location, color = Month)) +
#    facet_grid(cols = vars(Month)))
# dev.off()
```


